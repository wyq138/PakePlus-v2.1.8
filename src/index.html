
ï»¿<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>åŠ¨ç‰©åŒ»é™¢è¯Šç–—ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            touch-action: manipulation;
        }
        :root {
            --primary: #165DFF;
            --light-blue: #E8F3FF;
            --white: #FFFFFF;
            --gray: #F5F7FA;
            --text: #333333;
            --border: #DCDFE6;
        }
        body {
            background-color: var(--gray);
            color: var(--text);
            min-height: 100vh;
            background: url('https://img1.baidu.com/it/u=3804267959,2738637299&fm=253&fmt=auto&app=138&f=JPEG?w=800&h=500') no-repeat center center fixed;
            background-size: cover;
            background-attachment: fixed;
        }
        .container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            padding: 10px;
        }
        .login-box {
            width: 90%;
            max-width: 450px;
            margin: 50px auto;
            background: var(--white);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            border-top: 4px solid var(--primary);
        }
        .login-box h2 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .login-box .input-group {
            margin: 12px 0;
        }
        .login-box select, .login-box input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            margin-top: 5px;
        }
        .login-box .add-account {
            text-align: right;
            margin-top: 8px;
            font-size: 14px;
            color: var(--primary);
            cursor: pointer;
        }
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            touch-action: manipulation;
        }
        .btn-primary {
            background: var(--primary);
            color: var(--white);
            flex: 1;
        }
        .btn-secondary {
            background: var(--light-blue);
            color: var(--primary);
            flex: 1;
        }
        .btn-sm {
            padding: 8px 12px;
            font-size: 14px;
        }
        .main-page {
            display: none;
            background: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            overflow: hidden;
            width: 100%;
        }
        .header {
            background: var(--primary);
            color: var(--white);
            padding: 12px 15px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }
        .header h3 {
            font-weight: 600;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .header .user-info {
            font-size: 14px;
            padding: 4px 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
        }
        .header .btn-group {
            display: flex;
            gap: 8px;
        }
        .tab-nav {
            display: flex;
            background: var(--light-blue);
            overflow-x: auto;
            border-bottom: 1px solid var(--border);
            -webkit-overflow-scrolling: touch;
        }
        .tab-nav .tab-item {
            padding: 12px 15px;
            cursor: pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
        }
        .tab-nav .tab-item i, .tab-nav .tab-item span.emoji {
            font-size: 14px;
        }
        .tab-nav .tab-item.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 500;
        }
        .tab-content {
            padding: 15px;
            min-height: 500px;
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .form-group {
            margin: 12px 0;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 14px;
        }
        .form-control, .form-select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            resize: vertical;
            font-size: 14px;
        }
        .form-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .form-col {
            flex: 1;
            min-width: 180px;
        }
        .card {
            background: var(--gray);
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
        }
        .list {
            margin-top: 15px;
            border: 1px solid var(--border);
            border-radius: 4px;
            overflow: hidden;
        }
        .list-header {
            background: var(--light-blue);
            padding: 10px;
            display: flex;
            justify-content: space-between;
            font-weight: 500;
            font-size: 14px;
        }
        .list-item {
            padding: 12px 10px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            font-size: 14px;
        }
        .list-item:active {
            background: var(--light-blue);
        }
        .footer {
            text-align: center;
            padding: 12px;
            background: var(--light-blue);
            color: var(--text);
            margin-top: 15px;
            border-top: 1px solid var(--border);
            font-size: 13px;
        }
        .hidden {
            display: none !important;
        }
        .modal {
            position: fixed;
            top:0;
            left:0;
            width:100%;
            height:100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
            padding: 10px;
        }
        .modal-content {
            background: var(--white);
            width: 100%;
            max-width: 600px;
            padding: 20px;
            border-radius: 8px;
            border-top:4px solid var(--primary);
        }
        .modal-title {
            color: var(--primary);
            margin-bottom: 12px;
            padding-bottom:8px;
            border-bottom:1px solid var(--border);
            display: flex;
            align-items: center;
            gap:6px;
            font-size: 16px;
        }
        .modal-body {
            line-height: 1.8;
            margin:8px 0;
            font-size: 14px;
        }
        .modal-footer {
            text-align: right;
            margin-top:15px;
        }
        .search-box {
            margin: 12px 0;
            display: flex;
            gap:8px;
            align-items: center;
            flex-wrap: wrap;
        }
        .search-input {
            flex:1;
            min-width: 200px;
            padding:10px;
            border:1px solid var(--border);
            border-radius:4px;
            font-size: 14px;
        }
        .chart-box {
            width:100%;
            height:350px;
            margin:15px 0;
            border:1px solid var(--border);
            border-radius:4px;
        }
        .record-template {
            width:100%;
            padding:15px;
            background: #fff;
            border:1px solid var(--border);
            border-radius:4px;
            margin:10px 0;
            line-height: 1.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç™»å½•é¡µé¢ -->
        <div class="login-box" id="loginPage">
            <h2><i class="fa fa-heartbeat"></i> åŠ¨ç‰©åŒ»é™¢è¯Šç–—ç®¡ç†ç³»ç»Ÿç™»å½•</h2>
            <div class="input-group">
                <label>é€‰æ‹©è´¦å·</label>
                <select id="accountSelect" class="form-select"></select>
            </div>
            <div class="input-group">
                <label>ç™»å½•å¯†ç </label>
                <input type="password" id="loginPwd" placeholder="è¯·è¾“å…¥è´¦å·å¯†ç ">
            </div>
            <div class="add-account" onclick="showAddAccount()">æ–°å¢åŒ»ç”Ÿè´¦å·</div>
            <div class="input-group hidden" id="addAccountBox">
                <label>è´¦å·åç§°</label>
                <input type="text" id="newAccount" placeholder="å¦‚ï¼šæåŒ»ç”Ÿ">
                <label style="margin-top:8px;">è´¦å·å¯†ç </label>
                <input type="password" id="newPwd" placeholder="è®¾ç½®ç™»å½•å¯†ç ">
                <label style="margin-top:8px;">è´¦å·ç­‰çº§</label>
                <select id="newLevel" class="form-select">
                    <option value="doctor">æ™®é€šåŒ»ç”Ÿ</option>
                    <option value="admin">ç®¡ç†å‘˜</option>
                </select>
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="importAllData()"><i class="fa fa-upload"></i> å¯¼å…¥è´¦å·</button>
                <button class="btn btn-primary" id="mainBtn" onclick="handleLogin()">ç™»å½•ç³»ç»Ÿ</button>
            </div>
        </div>

        <!-- ä¸»é¡µé¢ -->
        <div class="main-page" id="mainPage">
            <div class="header">
                <h3><i class="fa fa-hospital-o"></i> åŠ¨ç‰©åŒ»é™¢è¯Šç–—ç®¡ç†ç³»ç»Ÿ</h3>
                <div class="user-info" id="currentUser">å½“å‰ç™»å½•ï¼šæš‚æ— </div>
                <div class="btn-group">
                    <button class="btn btn-sm btn-secondary" onclick="showTab('personal')"><i class="fa fa-user"></i> ä¸ªäººè®¾ç½®</button>
                    <button class="btn btn-sm btn-secondary" onclick="exportAllData()"><i class="fa fa-download"></i> å¯¼å‡ºè´¦å·</button>
                    <button class="btn btn-sm btn-secondary" onclick="logout()"><i class="fa fa-sign-out"></i> é€€å‡º</button>
                </div>
            </div>

            <div class="tab-nav" id="mainTabNav">
                <div class="tab-item active doctor-tab" onclick="switchTab('outpatient')"><i class="fa fa-stethoscope"></i> é—¨è¯Šç—…äºº</div>
                <div class="tab-item doctor-tab" onclick="switchTab('emergency')"><i class="fa fa-ambulance"></i> æ€¥è¯Šç—…äºº</div>
                <div class="tab-item doctor-tab" onclick="switchTab('hospitalized')"><i class="fa fa-bed"></i> ä½é™¢ç—…äºº</div>
                <div class="tab-item doctor-tab" onclick="switchTab('bed')"><i class="fa fa-building-o"></i> åºŠä½ç®¡ç†</div>
                <div class="tab-item doctor-tab" onclick="switchTab('operation')"><i class="fa fa-scissors"></i> æ‰‹æœ¯ç®¡ç†</div>
                <div class="tab-item doctor-tab" onclick="switchTab('autopsy')"><i class="fa fa-search"></i> å°¸æ£€ç®¡ç†</div>
                <div class="tab-item doctor-tab" onclick="switchTab('death')"><i class="fa fa-times-circle"></i> æ­»äº¡ç—…äºº</div>
                <div class="tab-item doctor-tab" onclick="switchTab('medicalRecord')"><i class="fa fa-file-text-o"></i> ç—…å†ç®¡ç†</div>
                <div class="tab-item doctor-tab" onclick="switchTab('file')"><i class="fa fa-file-medical-o"></i> ç—…ç†/æ£€æŸ¥æŠ¥å‘Š</div>
                <div class="tab-item doctor-tab" onclick="switchTab('check')"><i class="fa fa-flask"></i> æ£€æŸ¥å¼€å•</div>
                <div class="tab-item admin-tab hidden" onclick="switchTab('doctor')"><span class="emoji">ğŸ‘¨â€âš•ï¸</span> åŒ»ç”Ÿç®¡ç†</div>
                <div class="tab-item admin-tab hidden" onclick="switchTab('statistics')"><i class="fa fa-bar-chart"></i> æ•°æ®åˆ†æ</div>
            </div>

            <!-- é—¨è¯Šç—…äºº -->
            <div class="tab-content active doctor-tab" id="outpatient">
                <h4><i class="fa fa-stethoscope"></i> é—¨è¯Šç—…äººå½•å…¥</h4>
                <div class="form-row">
                    <div class="form-col"><div class="form-group"><label>åŠ¨ç‰©å§“å</label><input class="form-control" id="outName"></div><div class="form-group"><label>åŠ¨ç‰©ç§ç±»</label><input class="form-control" id="outType"></div></div>
                    <div class="form-col"><div class="form-group"><label>ä¸»äººå§“å</label><input class="form-control" id="outOwner"></div><div class="form-group"><label>è”ç³»ç”µè¯</label><input class="form-control" id="outPhone"></div></div>
                </div>
                <div class="form-group"><label>ç—‡çŠ¶æè¿°</label><textarea class="form-control" id="outSymptom" rows="2"></textarea></div>
                <h5>å¼€è¯è®°å½•</h5>
                <div class="form-row">
                    <div class="form-col"><label>è¯å“åç§°</label><input class="form-control" id="outDrugName"></div>
                    <div class="form-col"><label>å‰‚é‡</label><select class="form-select" id="outDrugDose"><option>1mg</option><option>2mg</option><option>5mg</option><option>10mg</option><option>20mg</option></select></div>
                    <div class="form-col"><label>æœç”¨æ–¹å¼</label><select class="form-select" id="outDrugWay"><option>å£æœ</option><option>è‚Œæ³¨</option><option>é™æ³¨</option><option>å¤–ç”¨</option><option>çš®ä¸‹æ³¨å°„</option></select></div>
                </div>
                <h5>åŒ»ç”ŸåŒ»å˜±</h5>
                <div class="form-row">
                    <div class="form-col"><label>åŒ»å˜±åç§°</label><input class="form-control" id="outAdvName"></div>
                    <div class="form-col"><label>å‰‚é‡</label><select class="form-select" id="outAdvDose"><option>1æ¬¡/å¤©</option><option>2æ¬¡/å¤©</option><option>1æ¬¡/2å¤©</option><option>1æ¬¡/3å¤©</option></select></div>
                    <div class="form-col"><label>æ‰§è¡Œæ–¹å¼</label><select class="form-select" id="outAdvWay"><option>å±…å®¶æ‰§è¡Œ</option><option>é—¨è¯Šæ‰§è¡Œ</option></select></div>
                </div>
                <button class="btn btn-primary" onclick="addData('outpatient')">æ·»åŠ é—¨è¯Šç—…äºº</button>
                <div class="list" id="outpatientList"></div>
            </div>

            <!-- æ€¥è¯Šç—…äºº -->
            <div class="tab-content doctor-tab" id="emergency">
                <h4><i class="fa fa-ambulance"></i> æ€¥è¯Šç—…äººå½•å…¥</h4>
                <div class="form-row">
                    <div class="form-col"><div class="form-group"><label>åŠ¨ç‰©å§“å</label><input class="form-control" id="emName"></div><div class="form-group"><label>åŠ¨ç‰©ç§ç±»</label><input class="form-control" id="emType"></div></div>
                    <div class="form-col"><div class="form-group"><label>ä¸»äººå§“å</label><input class="form-control" id="emOwner"></div><div class="form-group"><label>è”ç³»ç”µè¯</label><input class="form-control" id="emPhone"></div></div>
                </div>
                <div class="form-group"><label>æ€¥è¯Šç—‡çŠ¶</label><textarea class="form-control" id="emSymptom" rows="2"></textarea></div>
                <h5>å¼€è¯è®°å½•</h5>
                <div class="form-row">
                    <div class="form-col"><label>è¯å“åç§°</label><input class="form-control" id="emDrugName"></div>
                    <div class="form-col"><label>å‰‚é‡</label><select class="form-select" id="emDrugDose"><option>1mg</option><option>2mg</option><option>5mg</option><option>10mg</option><option>20mg</option></select></div>
                    <div class="form-col"><label>æœç”¨æ–¹å¼</label><select class="form-select" id="emDrugWay"><option>å£æœ</option><option>è‚Œæ³¨</option><option>é™æ³¨</option><option>å¤–ç”¨</option><option>çš®ä¸‹æ³¨å°„</option></select></div>
                </div>
                <h5>åŒ»ç”ŸåŒ»å˜±</h5>
                <div class="form-row">
                    <div class="form-col"><label>åŒ»å˜±åç§°</label><input class="form-control" id="emAdvName"></div>
                    <div class="form-col"><label>å‰‚é‡</label><select class="form-select" id="emAdvDose"><option>1æ¬¡/å¤©</option><option>2æ¬¡/å¤©</option><option>1æ¬¡/2å¤©</option></select></div>
                    <div class="form-col"><label>æ‰§è¡Œæ–¹å¼</label><select class="form-select" id="emAdvWay"><option>æ€¥è¯Šæ‰§è¡Œ</option><option>ä½é™¢æ‰§è¡Œ</option></select></div>
                </div>
                <button class="btn btn-primary" onclick="addData('emergency')">æ·»åŠ æ€¥è¯Šç—…äºº</button>
                <div class="list" id="emergencyList"></div>
            </div>

            <!-- ä½é™¢ç—…äºº -->
            <div class="tab-content doctor-tab" id="hospitalized">
                <h4><i class="fa fa-bed"></i> ä½é™¢ç—…äººå½•å…¥</h4>
                <div class="form-row">
                    <div class="form-col"><div class="form-group"><label>åŠ¨ç‰©å§“å</label><input class="form-control" id="hosName"></div><div class="form-group"><label>åŠ¨ç‰©ç§ç±»</label><input class="form-control" id="hosType"></div></div>
                    <div class="form-col"><div class="form-group"><label>ä¸»äººå§“å</label><input class="form-control" id="hosOwner"></div><div class="form-group"><label>åºŠä½å·</label><input class="form-control" id="hosBed"></div></div>
                </div>
                <div class="form-group"><label>è¯Šæ–­ç»“æœ</label><textarea class="form-control" id="hosDiagnose" rows="2"></textarea></div>
                <h5>å¼€è¯è®°å½•</h5>
                <div class="form-row">
                    <div class="form-col"><label>è¯å“åç§°</label><input class="form-control" id="hosDrugName"></div>
                    <div class="form-col"><label>å‰‚é‡</label><select class="form-select" id="hosDrugDose"><option>1mg</option><option>2mg</option><option>5mg</option><option>10mg</option><option>20mg</option></select></div>
                    <div class="form-col"><label>æœç”¨æ–¹å¼</label><select class="form-select" id="hosDrugWay"><option>å£æœ</option><option>è‚Œæ³¨</option><option>é™æ³¨</option><option>å¤–ç”¨</option><option>çš®ä¸‹æ³¨å°„</option></select></div>
                </div>
                <h5>æŠ¤å£«è¾“æ¶²åŒ»å˜±</h5>
                <div class="form-row">
                    <div class="form-col"><label>æ¶²ä½“åç§°</label><input class="form-control" id="hosFluidName"></div>
                    <div class="form-col"><label>å‰‚é‡</label><select class="form-select" id="hosFluidDose"><option>50ml</option><option>100ml</option><option>250ml</option><option>500ml</option></select></div>
                    <div class="form-col"><label>è¾“æ³¨æ–¹å¼</label><select class="form-select" id="hosFluidWay"><option>é™æ»´</option><option>é™æ¨</option><option>æ³µæ³¨</option></select></div>
                </div>
                <button class="btn btn-primary" onclick="addData('hospitalized')">æ·»åŠ ä½é™¢ç—…äºº</button>
                <div class="list" id="hospitalizedList"></div>
            </div>

            <!-- åºŠä½ç®¡ç†ï¼ˆæ ¸å¿ƒä¼˜åŒ–ï¼šå…ˆåŠ åºŠä½å†å…¥ä½ï¼‰ -->
            <div class="tab-content doctor-tab" id="bed">
                <h4><i class="fa fa-building-o"></i> åºŠä½ä¿¡æ¯å½•å…¥ï¼ˆå…ˆåŠ åºŠä½ï¼Œå†ç‚¹åºŠä½å…¥ä½ï¼‰</h4>
                <div class="form-row">
                    <div class="form-col">
                        <div class="form-group"><label>åºŠä½å·</label><input class="form-control" id="bedNo" placeholder="å¦‚ï¼š1ã€2ã€3..."></div>
                    </div>
                    <div class="form-col">
                        <div class="form-group"><label>åˆå§‹çŠ¶æ€</label>
                            <select class="form-select" id="bedStatus">
                                <option value="ç©ºé—²">ç©ºé—²</option>
                                <option value="å ç”¨">å ç”¨</option>
                            </select>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="addData('bed')">æ·»åŠ åºŠä½</button>
                <div class="list" id="bedList"></div>
            </div>

            <!-- æ‰‹æœ¯ç®¡ç† -->
            <div class="tab-content doctor-tab" id="operation">
                <h4><i class="fa fa-scissors"></i> æ‰‹æœ¯ä¿¡æ¯å½•å…¥</h4>
                <div class="form-row">
                    <div class="form-col"><div class="form-group"><label>åŠ¨ç‰©å§“å</label><input class="form-control" id="opName"></div><div class="form-group"><label>æ‰‹æœ¯åç§°</label><input class="form-control" id="opType"></div></div>
                    <div class="form-col"><div class="form-group"><label>ä¸»åˆ€åŒ»ç”Ÿ</label><input class="form-control" id="opDoctor"></div><div class="form-group"><label>æ‰‹æœ¯æ—¥æœŸ</label><input type="date" class="form-control" id="opDate"></div></div>
                </div>
                <div class="form-group"><label>æ‰‹æœ¯æè¿°</label><textarea class="form-control" id="opDesc" rows="2"></textarea></div>
                <h5>æœ¯åç”¨è¯è®°å½•</h5>
                <div class="form-row">
                    <div class="form-col"><label>è¯å“åç§°</label><input class="form-control" id="opDrugName"></div>
                    <div class="form-col"><label>å‰‚é‡</label><select class="form-select" id="opDrugDose"><option>1mg</option><option>2mg</option><option>5mg</option><option>10mg</option><option>20mg</option></select></div>
                    <div class="form-col"><label>æœç”¨æ–¹å¼</label><select class="form-select" id="opDrugWay"><option>å£æœ</option><option>è‚Œæ³¨</option><option>é™æ³¨</option><option>å¤–ç”¨</option><option>çš®ä¸‹æ³¨å°„</option></select></div>
                </div>
                <button class="btn btn-primary" onclick="addData('operation')">æ·»åŠ æ‰‹æœ¯è®°å½•</button>
                <div class="list" id="operationList"></div>
            </div>

            <!-- å°¸æ£€ç®¡ç† -->
            <div class="tab-content doctor-tab" id="autopsy">
                <h4><i class="fa fa-search"></i> å°¸æ£€ä¿¡æ¯å½•å…¥</h4>
                <div class="form-row">
                    <div class="form-col"><div class="form-group"><label>åŠ¨ç‰©å§“å</label><input class="form-control" id="auName"></div><div class="form-group"><label>åŠ¨ç‰©ç§ç±»</label><input class="form-control" id="auType"></div></div>
                    <div class="form-col"><div class="form-group"><label>å°¸æ£€åŒ»ç”Ÿ</label><input class="form-control" id="auDoctor"></div><div class="form-group"><label>å°¸æ£€æ—¥æœŸ</label><input type="date" class="form-control" id="auDate"></div></div>
                </div>
                <div class="form-group"><label>å°¸æ£€ç»“è®º</label><textarea class="form-control" id="auResult" rows="2"></textarea></div>
                <button class="btn btn-primary" onclick="addData('autopsy')">æ·»åŠ å°¸æ£€è®°å½•</button>
                <div class="list" id="autopsyList"></div>
            </div>

            <!-- æ­»äº¡ç—…äºº -->
            <div class="tab-content doctor-tab" id="death">
                <h4><i class="fa fa-times-circle"></i> æ­»äº¡ç—…äººå½•å…¥</h4>
                <div class="form-row">
                    <div class="form-col"><div class="form-group"><label>åŠ¨ç‰©å§“å</label><input class="form-control" id="deName"></div><div class="form-group"><label>åŠ¨ç‰©ç§ç±»</label><input class="form-control" id="deType"></div></div>
                    <div class="form-col"><div class="form-group"><label>ä¸»äººå§“å</label><input class="form-control" id="deOwner"></div><div class="form-group"><label>æ­»äº¡æ—¥æœŸ</label><input type="date" class="form-control" id="deDate"></div></div>
                </div>
                <div class="form-group"><label>æ­»äº¡åŸå› </label><textarea class="form-control" id="deReason" rows="2"></textarea></div>
                <button class="btn btn-primary" onclick="addData('death')">æ·»åŠ æ­»äº¡ç—…äºº</button>
                <div class="list" id="deathList"></div>
            </div>

            <!-- ç—…å†ç®¡ç†-æ¨¡æ¿ -->
            <div class="tab-content doctor-tab" id="medicalRecord">
                <h4><i class="fa fa-file-text-o"></i> ç—…å†ç®¡ç†ï¼ˆæŒ‰åŠ¨ç‰©å§“åæœç´¢ï¼‰</h4>
                <div class="search-box">
                    <input type="text" class="search-input" id="mrSearch" placeholder="è¾“å…¥åŠ¨ç‰©å§“åæŸ¥è¯¢/ç”Ÿæˆç—…å†">
                    <button class="btn btn-primary btn-sm" onclick="searchMedicalRecord()">æœç´¢/ç”Ÿæˆ</button>
                </div>
                <div class="record-template" id="recordTemplate">
                    <h5 style="text-align:center;">XXåŠ¨ç‰©åŒ»é™¢ é—¨è¯Šç—…å†è®°å½•</h5>
                    <p>åŠ¨ç‰©å§“åï¼š<span id="tplName">--</span>  åŠ¨ç‰©ç§ç±»ï¼š<span id="tplType">--</span>  ä¸»äººå§“åï¼š<span id="tplOwner">--</span>  è”ç³»ç”µè¯ï¼š<span id="tplPhone">--</span></p>
                    <p>æ¥è¯ŠåŒ»ç”Ÿï¼š<span id="tplDoctor">--</span>  æ¥è¯Šæ—¥æœŸï¼š<span id="tplDate">--</span></p>
                    <p>ç—‡çŠ¶æè¿°ï¼š<span id="tplSymptom">--</span></p>
                    <p>è¯Šæ–­ç»“æœï¼š<span id="tplDiagnose">--</span></p>
                    <p>å¼€è¯è®°å½•ï¼š<span id="tplDrug">--</span></p>
                    <p>åŒ»å˜±å†…å®¹ï¼š<span id="tplAdvice">--</span></p>
                    <p>å¤æŸ¥å»ºè®®ï¼š<textarea class="form-control" id="tplReview" rows="1" placeholder="å¡«å†™å¤æŸ¥å»ºè®®"></textarea></p>
                </div>
                <button class="btn btn-primary" onclick="saveMedicalRecord()">ä¿å­˜ç—…å†</button>
                <div class="list" id="medicalRecordList"></div>
            </div>

            <!-- ç—…ç†/æ£€æŸ¥æŠ¥å‘Š -->
            <div class="tab-content doctor-tab" id="file">
                <h4><i class="fa fa-file-medical-o"></i> ç—…ç†æŠ¥å‘Šå¯¼å…¥</h4>
                <input type="file" id="reportFile" class="form-control" accept=".pdf,.doc,.docx,.txt,.jpg,.png">
                <button class="btn btn-primary" onclick="uploadFile('report')">å¯¼å…¥ç—…ç†æŠ¥å‘Š</button>
                <h4 style="margin-top:15px;"><i class="fa fa-picture-o"></i> å°¸æ£€/æ‰‹æœ¯å›¾ç‰‡ä¸Šä¼ </h4>
                <input type="file" id="imgFile" class="form-control" accept="image/*">
                <button class="btn btn-primary" onclick="uploadFile('image')">ä¸Šä¼ å›¾ç‰‡</button>
                <h4 style="margin-top:15px;"><i class="fa fa-file-text-o"></i> æ£€æŸ¥æŠ¥å‘Šä¸Šä¼ </h4>
                <input type="file" id="checkFile" class="form-control" accept=".pdf,.doc,.docx,.txt,.jpg,.png">
                <button class="btn btn-primary" onclick="uploadFile('checkReport')">ä¸Šä¼ æ£€æŸ¥æŠ¥å‘Š</button>
                <div class="list" id="fileList"></div>
            </div>

            <!-- æ£€æŸ¥å¼€å• -->
            <div class="tab-content doctor-tab" id="check">
                <h4><i class="fa fa-flask"></i> æ£€æŸ¥å¼€å•å½•å…¥</h4>
                <div class="form-row">
                    <div class="form-col"><div class="form-group"><label>åŠ¨ç‰©å§“å</label><input class="form-control" id="chkName"></div><div class="form-group"><label>æ£€æŸ¥åŒ»ç”Ÿ</label><input class="form-control" id="chkDoctor"></div></div>
                    <div class="form-col"><div class="form-group"><label>é€‰æ‹©æ£€æŸ¥é¡¹</label><select class="form-select" id="chkType" onchange="customCheck()"><option>è¡€ç»†èƒè®¡æ•°</option><option>ç²ªä¾¿å¸¸è§„</option><option>å°¿å¸¸è§„</option><option>ç”ŸåŒ–å…¨å¥—</option><option>Xå…‰æ£€æŸ¥</option><option>Bè¶…æ£€æŸ¥</option><option>ç—…åŸå­¦æ£€æµ‹</option><option>è‡ªå®šä¹‰æ£€æŸ¥</option></select></div><div class="form-group"><label>è‡ªå®šä¹‰æ£€æŸ¥åç§°</label><input class="form-control" id="chkCustom" placeholder="é€‰æ‹©è‡ªå®šä¹‰æ—¶å¡«å†™" disabled></div></div>
                </div>
                <div class="form-group"><label>æ£€æŸ¥å¤‡æ³¨</label><textarea class="form-control" id="chkRemark" rows="2" placeholder="æ£€æŸ¥è¦æ±‚ã€æ³¨æ„äº‹é¡¹ç­‰"></textarea></div>
                <button class="btn btn-primary" onclick="addData('check')">ä¿å­˜æ£€æŸ¥å¼€å•</button>
                <div class="list" id="checkList"></div>
            </div>

            <!-- åŒ»ç”Ÿç®¡ç†-ä»…ç®¡ç†å‘˜ -->
            <div class="tab-content admin-tab hidden" id="doctor">
                <h4><span class="emoji">ğŸ‘¨â€âš•ï¸</span> åŒ»ç”Ÿä¿¡æ¯å½•å…¥</h4>
                <div class="form-row">
                    <div class="form-col"><div class="form-group"><label>åŒ»ç”Ÿå§“å</label><input class="form-control" id="docName"></div><div class="form-group"><label>èŒç§°</label><input class="form-control" id="docTitle"></div></div>
                    <div class="form-col"><div class="form-group"><label>ç§‘å®¤</label><input class="form-control" id="docDept"></div><div class="form-group"><label>è”ç³»ç”µè¯</label><input class="form-control" id="docPhone"></div></div>
                </div>
                <button class="btn btn-primary" onclick="addData('doctor')">æ·»åŠ åŒ»ç”Ÿ</button>
                <div class="list" id="doctorList"></div>
            </div>

            <!-- ä¸ªäººè®¾ç½® -->
            <div class="tab-content" id="personal">
                <h4><i class="fa fa-user"></i> å¯†ç ä¿®æ”¹</h4>
                <div class="form-group"><label>åŸç™»å½•å¯†ç </label><input type="password" class="form-control" id="oldLoginPwd"></div>
                <div class="form-group"><label>æ–°ç™»å½•å¯†ç </label><input type="password" class="form-control" id="newLoginPwd"></div>
                <button class="btn btn-primary" onclick="updatePwd('login')">ä¿®æ”¹ç™»å½•å¯†ç </button>
                <div id="adminPwdBox" class="hidden">
                    <h4 style="margin-top:15px;"><i class="fa fa-lock"></i> åå°å¯†ç ä¿®æ”¹</h4>
                    <div class="form-group"><label>åŸåå°å¯†ç </label><input type="password" class="form-control" id="oldAdminPwd"></div>
                    <div class="form-group"><label>æ–°åå°å¯†ç </label><input type="password" class="form-control" id="newAdminPwd"></div>
                    <button class="btn btn-primary" onclick="updatePwd('admin')">ä¿®æ”¹åå°å¯†ç </button>
                </div>
                <h4 style="margin-top:15px;"><i class="fa fa-trash"></i> æ•°æ®ç®¡ç†</h4>
                <button class="btn btn-secondary" onclick="clearAllData()">æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®ï¼ˆè°¨æ…ï¼‰</button>
            </div>

            <!-- æ•°æ®åˆ†æ-ä»…ç®¡ç†å‘˜ -->
            <div class="tab-content admin-tab hidden" id="statistics">
                <h4><i class="fa fa-bar-chart"></i> è¯Šç–—æ•°æ®ç»Ÿè®¡ï¼ˆæ‰‡å½¢å›¾ï¼‰</h4>
                <div class="chart-box" id="statChart"></div>
                <div class="form-row" style="margin-top:15px;">
                    <div class="form-col"><div class="card"><p>é—¨è¯Šæ€»æ•°ï¼š<span id="outCount">0</span></p></div></div>
                    <div class="form-col"><div class="card"><p>æ€¥è¯Šæ€»æ•°ï¼š<span id="emCount">0</span></p></div></div>
                    <div class="form-col"><div class="card"><p>ä½é™¢æ€»æ•°ï¼š<span id="hosCount">0</span></p></div></div>
                    <div class="form-col"><div class="card"><p>æ­»äº¡æ€»æ•°ï¼š<span id="deCount">0</span></p></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- åºŠä½å…¥ä½å¼¹çª—ï¼ˆæ–°å¢ï¼‰ -->
    <div class="modal" id="bedInModal">
        <div class="modal-content">
            <h3 class="modal-title"><i class="fa fa-bed"></i> åºŠä½å…¥ä½ç™»è®°</h3>
            <input type="hidden" id="currentBedNo">
            <div class="modal-body">
                <div class="form-group"><label>åŠ¨ç‰©å§“å</label><input class="form-control" id="inAnimalName" placeholder="è¾“å…¥å…¥ä½åŠ¨ç‰©å§“å"></div>
                <div class="form-group"><label>åŠ¨ç‰©ç§ç±»</label><input class="form-control" id="inAnimalType" placeholder="å¦‚ï¼šçŠ¬ã€çŒ«"></div>
                <div class="form-group"><label>ä¸»äººå§“å</label><input class="form-control" id="inOwnerName" placeholder="è¾“å…¥ä¸»äººå§“å"></div>
                <div class="form-group"><label>è”ç³»ç”µè¯</label><input class="form-control" id="inPhone" placeholder="è¾“å…¥è”ç³»ç”µè¯"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary btn-sm" onclick="closeModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary btn-sm" onclick="submitBedIn()">ç¡®è®¤å…¥ä½</button>
            </div>
        </div>
    </div>

    <!-- é€šç”¨è¯¦æƒ…å¼¹çª— -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <h3 class="modal-title" id="modalTitle">è®°å½•è¯¦æƒ…</h3>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer"><button class="btn btn-primary btn-sm" onclick="closeModal()">å…³é—­</button></div>
        </div>
    </div>

    <!-- åº•éƒ¨å…³äº -->
    <div class="footer">
        <p>å…³äºç³»ç»Ÿ | å¼€å‘è€…ï¼šå¹³æ­¦å¿è½¯ä»¶ç³»ç»Ÿå¼€å‘æœ‰é™å…¬å¸ | è”ç³»ç”µè¯ï¼š18281970402</p>
    </div>

    <script>
        // åˆå§‹åŒ–åŸºç¡€æ•°æ®+ç¼“å­˜DOMæé€Ÿ
        function initLocalStorage() {
            // ç¡®ä¿localStorageå¯ç”¨
            try {
                // æµ‹è¯•localStorageæ˜¯å¦å¯ç”¨
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                
                // åˆå§‹åŒ–é»˜è®¤è´¦å·æ•°æ®
                if(!localStorage.getItem('accounts')) {
                    localStorage.setItem('accounts', JSON.stringify([{name:'ç®¡ç†å‘˜',pwd:'admin888',level:'admin'},{name:'æ™®é€šåŒ»ç”Ÿ',pwd:'123456',level:'doctor'}]));
                }
                if(!localStorage.getItem('loginPwd')) {
                    localStorage.setItem('loginPwd', '123456');
                }
                if(!localStorage.getItem('adminPwd')) {
                    localStorage.setItem('adminPwd', 'admin888');
                }
            } catch (e) {
                console.error('localStorageåˆå§‹åŒ–å¤±è´¥:', e);
                alert('æœ¬åœ°å­˜å‚¨åˆå§‹åŒ–å¤±è´¥ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®æ— æ³•ä¿å­˜ï¼');
            }
        }
        
        // å®‰å…¨çš„localStorageæ“ä½œå‡½æ•°
        function safeLocalStorageSet(key, value) {
            try {
                localStorage.setItem(key, value);
                return true;
            } catch (e) {
                console.error('localStorageå†™å…¥å¤±è´¥:', e);
                return false;
            }
        }
        
        function safeLocalStorageGet(key, defaultValue) {
            try {
                return localStorage.getItem(key) || defaultValue;
            } catch (e) {
                console.error('localStorageè¯»å–å¤±è´¥:', e);
                return defaultValue;
            }
        }
        
        // åˆå§‹åŒ–localStorage
        initLocalStorage();
        
        let isAdmin = false, currentUser = '', myChart = null, currentBedIndex = -1;
        // ç¼“å­˜å¸¸ç”¨DOMå…ƒç´ 
        const $accountSelect = document.getElementById('accountSelect'), $addAccountBox = document.getElementById('addAccountBox'), $mainBtn = document.getElementById('mainBtn');
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            // åˆå§‹åŒ–è´¦å·é€‰æ‹©æ¡†
            initAccountSelect();
            
            const savedLogin = localStorage.getItem('currentLogin');
            if(savedLogin) {
                const loginInfo = JSON.parse(savedLogin);
                const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
                const user = accounts.find(item => item.name === loginInfo.name);
                if(user && user.pwd === loginInfo.pwd) {
                    isAdmin = user.level === 'admin';
                    currentUser = user.name;
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainPage').style.display = 'block';
                    document.getElementById('currentUser').innerText = `å½“å‰ç™»å½•ï¼š${currentUser}ï¼ˆ${isAdmin?'ç®¡ç†å‘˜':'åŒ»ç”Ÿ'}ï¼‰`;
                    if(isAdmin) {
                        document.querySelectorAll('.doctor-tab').forEach(item => item.classList.add('hidden'));
                        document.querySelectorAll('.admin-tab').forEach(item => item.classList.remove('hidden'));
                        document.getElementById('adminPwdBox').classList.remove('hidden');
                    } else {
                        document.querySelectorAll('.doctor-tab').forEach(item => item.classList.remove('hidden'));
                        document.querySelectorAll('.admin-tab').forEach(item => item.classList.add('hidden'));
                        document.getElementById('adminPwdBox').classList.add('hidden');
                    }
                    loadAllLists();
                }
            }
        };

        // åˆå§‹åŒ–è´¦å·é€‰æ‹©æ¡†-æ˜¾çº¯è´¦å·å
        function initAccountSelect() {
            const accounts = JSON.parse(localStorage.getItem('accounts') || '[]');
            $accountSelect.innerHTML = accounts.map((item, i) => `<option value="${i}">${item.name}ï¼ˆ${item.level==='admin'?'ç®¡ç†å‘˜':'åŒ»ç”Ÿ'}ï¼‰</option>`).join('');
        }
        initAccountSelect();

        // æ˜¾ç¤ºæ–°å¢è´¦å·æ¡†+åˆ‡æ¢æŒ‰é’®ä¸ºä¿å­˜
        function showAddAccount() {
            $addAccountBox.classList.toggle('hidden');
            $mainBtn.innerText = $addAccountBox.classList.contains('hidden') ? 'ç™»å½•ç³»ç»Ÿ' : 'ä¿å­˜è´¦å·';
            $mainBtn.onclick = $addAccountBox.classList.contains('hidden') ? handleLogin : saveNewAccount;
        }

        // ä¿å­˜æ–°è´¦å·-è‡ªåŠ¨æœ¬åœ°å­˜+éšè—è¾“å…¥æ¡†+åˆ·æ–°ä¸‹æ‹‰
        function saveNewAccount() {
            const name = document.getElementById('newAccount').value.trim(), pwd = document.getElementById('newPwd').value.trim(), level = document.getElementById('newLevel').value;
            if(!name || !pwd) return alert('è´¦å·å’Œå¯†ç ä¸èƒ½ä¸ºç©ºï¼');
            
            try {
                const accounts = JSON.parse(safeLocalStorageGet('accounts', '[]'));
                accounts.push({name, pwd, level});
                
                if(safeLocalStorageSet('accounts', JSON.stringify(accounts))) {
                    initAccountSelect();
                    alert('è´¦å·ä¿å­˜æˆåŠŸï¼');
                    $addAccountBox.classList.add('hidden');
                    $mainBtn.innerText = 'ç™»å½•ç³»ç»Ÿ';
                    $mainBtn.onclick = handleLogin;
                    document.getElementById('newAccount').value = '';
                    document.getElementById('newPwd').value = '';
                } else {
                    alert('è´¦å·ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                }
            } catch (e) {
                console.error('ä¿å­˜è´¦å·å¤±è´¥:', e);
                alert('è´¦å·ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            }
        }

        // ç™»å½•å¤„ç†
        function handleLogin() {
            const accountIdx = $accountSelect.value, inputPwd = document.getElementById('loginPwd').value;
            
            try {
                const accounts = JSON.parse(safeLocalStorageGet('accounts', '[]'));
                const user = accounts[accountIdx];
                
                if(!user) {
                    alert('è´¦å·ä¸å­˜åœ¨ï¼');
                    return;
                }
                
                if(user.pwd !== inputPwd) {
                    return alert('å¯†ç é”™è¯¯ï¼');
                }
                
                currentUser = user.name;
                isAdmin = user.level === 'admin';
                
                // ä¿å­˜ç™»å½•çŠ¶æ€åˆ°localStorage
                if(safeLocalStorageSet('currentLogin', JSON.stringify({name: user.name, pwd: user.pwd, level: user.level}))) {
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('mainPage').style.display = 'block';
                    document.getElementById('currentUser').innerText = `å½“å‰ç™»å½•ï¼š${currentUser}ï¼ˆ${isAdmin?'ç®¡ç†å‘˜':'åŒ»ç”Ÿ'}ï¼‰`;
                    if(isAdmin) {
                        document.querySelectorAll('.doctor-tab').forEach(item => item.classList.add('hidden'));
                        document.querySelectorAll('.admin-tab').forEach(item => item.classList.remove('hidden'));
                        document.getElementById('adminPwdBox').classList.remove('hidden');
                    } else {
                        document.querySelectorAll('.doctor-tab').forEach(item => item.classList.remove('hidden'));
                        document.querySelectorAll('.admin-tab').forEach(item => item.classList.add('hidden'));
                        document.getElementById('adminPwdBox').classList.add('hidden');
                    }
                    loadAllLists();
                } else {
                    alert('ç™»å½•çŠ¶æ€ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
                }
            } catch (e) {
                console.error('ç™»å½•å¤„ç†å¤±è´¥:', e);
                alert('ç™»å½•å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            }
        }

        // åˆ‡æ¢æ ‡ç­¾é¡µ-æƒé™æ ¡éªŒ
        function switchTab(tabId) {
            if((tabId === 'doctor' || tabId === 'statistics') && !isAdmin) return alert('æ— ç®¡ç†å‘˜æƒé™ï¼');
            document.querySelectorAll('.tab-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(item => item.classList.remove('active'));
            event.target?.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            if(tabId === 'statistics' && isAdmin) initChart();
        }

        function showTab(tabId) {
            if((tabId === 'doctor' || tabId === 'statistics') && !isAdmin) return alert('æ— ç®¡ç†å‘˜æƒé™ï¼');
            document.querySelectorAll('.tab-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(item => item.classList.remove('active'));
            const tabItem = document.querySelector(`.tab-item[onclick="switchTab('${tabId}')"]`);
            tabItem?.classList.add('active');
            document.getElementById(tabId).classList.add('active');
            if(tabId === 'statistics' && isAdmin) initChart();
        }

        // é€€å‡ºç™»å½•
        function logout() {
            try {
                // æ¸…é™¤ç™»å½•çŠ¶æ€
                localStorage.removeItem('currentLogin');
                document.getElementById('mainPage').style.display = 'none';
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('loginPwd').value = '';
                isAdmin = false; currentUser = '';
                // é‡æ–°åˆå§‹åŒ–è´¦å·é€‰æ‹©æ¡†
                initAccountSelect();
            } catch (e) {
                console.error('é€€å‡ºç™»å½•å¤±è´¥:', e);
                // å³ä½¿localStorageæ“ä½œå¤±è´¥ï¼Œä¹Ÿè¦åˆ‡æ¢åˆ°ç™»å½•é¡µé¢
                document.getElementById('mainPage').style.display = 'none';
                document.getElementById('loginPage').style.display = 'block';
                document.getElementById('loginPwd').value = '';
                isAdmin = false; currentUser = '';
                initAccountSelect();
            }
        }

        // è‡ªå®šä¹‰æ£€æŸ¥é¡¹åˆ‡æ¢
        function customCheck() {
            const chkType = document.getElementById('chkType').value, customInput = document.getElementById('chkCustom');
            customInput.disabled = chkType !== 'è‡ªå®šä¹‰æ£€æŸ¥';
            customInput.placeholder = chkType === 'è‡ªå®šä¹‰æ£€æŸ¥' ? 'è¯·è¾“å…¥æ£€æŸ¥åç§°' : 'é€‰æ‹©è‡ªå®šä¹‰æ—¶å¡«å†™';
        }

        // æ·»åŠ æ•°æ®-å…¨è‡ªåŠ¨æœ¬åœ°å­˜å‚¨
        function addData(type) {
            let data = {}; const now = new Date().toLocaleString();
            switch(type) {
                case 'outpatient': data = {name:document.getElementById('outName').value, type:document.getElementById('outType').value, owner:document.getElementById('outOwner').value, phone:document.getElementById('outPhone').value, symptom:document.getElementById('outSymptom').value, drug:`${document.getElementById('outDrugName').value} ${document.getElementById('outDrugDose').value} ${document.getElementById('outDrugWay').value}`, advice:`${document.getElementById('outAdvName').value} ${document.getElementById('outAdvDose').value} ${document.getElementById('outAdvWay').value}`, time:now}; break;
                case 'emergency': data = {name:document.getElementById('emName').value, type:document.getElementById('emType').value, owner:document.getElementById('emOwner').value, phone:document.getElementById('emPhone').value, symptom:document.getElementById('emSymptom').value, drug:`${document.getElementById('emDrugName').value} ${document.getElementById('emDrugDose').value} ${document.getElementById('emDrugWay').value}`, advice:`${document.getElementById('emAdvName').value} ${document.getElementById('emAdvDose').value} ${document.getElementById('emAdvWay').value}`, time:now}; break;
                case 'hospitalized': data = {name:document.getElementById('hosName').value, type:document.getElementById('hosType').value, owner:document.getElementById('hosOwner').value, bed:document.getElementById('hosBed').value, diagnose:document.getElementById('hosDiagnose').value, drug:`${document.getElementById('hosDrugName').value} ${document.getElementById('hosDrugDose').value} ${document.getElementById('hosDrugWay').value}`, fluid:`${document.getElementById('hosFluidName').value} ${document.getElementById('hosFluidDose').value} ${document.getElementById('hosFluidWay').value}`, time:now}; break;
                case 'bed': data = {no:document.getElementById('bedNo').value, status:document.getElementById('bedStatus').value, animal:'', owner:'', phone:'', type:'', time:now}; break;
                case 'operation': data = {name:document.getElementById('opName').value, type:document.getElementById('opType').value, doctor:document.getElementById('opDoctor').value, date:document.getElementById('opDate').value, desc:document.getElementById('opDesc').value, drug:`${document.getElementById('opDrugName').value} ${document.getElementById('opDrugDose').value} ${document.getElementById('opDrugWay').value}`, time:now}; break;
                case 'autopsy': data = {name:document.getElementById('auName').value, type:document.getElementById('auType').value, doctor:document.getElementById('auDoctor').value, date:document.getElementById('auDate').value, result:document.getElementById('auResult').value, time:now}; break;
                case 'death': data = {name:document.getElementById('deName').value, type:document.getElementById('deType').value, owner:document.getElementById('deOwner').value, date:document.getElementById('deDate').value, reason:document.getElementById('deReason').value, time:now}; break;
                case 'medicalRecord': data = {name:document.getElementById('tplName').innerText, content:document.getElementById('recordTemplate').innerHTML, doctor:currentUser, time:now}; break;
                case 'doctor': data = {name:document.getElementById('docName').value, title:document.getElementById('docTitle').value, dept:document.getElementById('docDept').value, phone:document.getElementById('docPhone').value, time:now}; break;
                case 'check': const chkType = document.getElementById('chkType').value; const checkName = chkType === 'è‡ªå®šä¹‰æ£€æŸ¥' ? document.getElementById('chkCustom').value : chkType; data = {name:document.getElementById('chkName').value, type:checkName, doctor:document.getElementById('chkDoctor').value, remark:document.getElementById('chkRemark').value, time:now}; break;
            }
            const list = JSON.parse(localStorage.getItem(type) || '[]');
            list.push(data); localStorage.setItem(type, JSON.stringify(list));
            loadList(type); clearInput(type); isAdmin && initChart();
            // åŒæ­¥åˆ°äº‘ç«¯
            syncDataToCloud();
        }

        // æ¸…ç©ºè¾“å…¥æ¡†
        function clearInput(type) {
            const prefixes = {outpatient:'out', emergency:'em', hospitalized:'hos', bed:'bed', operation:'op', autopsy:'au', death:'de', check:'chk', doctor:'doc'};
            const prefix = prefixes[type];
            if(prefix) document.querySelectorAll(`[id^="${prefix}"]`).forEach(el => el.value = el.tagName === 'SELECT' ? el.options[0].value : '');
        }

        // ä¸Šä¼ æŠ¥å‘Š/å›¾ç‰‡
        function uploadFile(type) {
            const fileInput = type === 'report' ? document.getElementById('reportFile') : type === 'image' ? document.getElementById('imgFile') : document.getElementById('checkFile');
            const file = fileInput.files[0];
            if(!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶ï¼');
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = {name:file.name, type, size:(file.size/1024).toFixed(2)+'KB', base64:e.target.result, time:new Date().toLocaleString()};
                const list = JSON.parse(localStorage.getItem('files') || '[]');
                list.push(data); localStorage.setItem('files', JSON.stringify(list));
                loadList('file'); fileInput.value = '';
            };
            reader.readAsDataURL(file);
        }

        // åŠ è½½å•ä¸ªåˆ—è¡¨-æ ¸å¿ƒï¼šåºŠä½ç‚¹å‡»å¼¹å…¥ä½æ¡†
        function loadList(type) {
            const listEl = document.getElementById(`${type === 'file' ? 'file' : type}List`);
            const storageKey = type === 'file' ? 'files' : type;
            const list = JSON.parse(localStorage.getItem(storageKey) || '[]');
            if(list.length === 0){listEl.innerHTML = '<div class="list-item">æš‚æ— æ•°æ®</div>'; return;}

            // åºŠä½åˆ—è¡¨ç‰¹æ®Šå¤„ç†ï¼šç‚¹å‡»å¼¹å…¥ä½æ¡†
            if(type === 'bed'){
                listEl.innerHTML = list.map((item, i) => `
                    <div class="list-item" onclick="openBedInModal(${i})">
                        <div>åºŠä½${item.no} - ${item.status} - å…¥ä½ï¼š${item.animal||'æ— '}</div>
                        <div>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();dischargeBed(${i})">å‡ºé™¢</button>
                            <button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();deleteItem('${storageKey}', ${i})">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
                return;
            }

            listEl.innerHTML = list.map((item, i) => `<div class="list-item" onclick="showDetail('${storageKey}', ${i})"><div>${item.name || item.no || 'è®°å½•'} - ${item.time}</div><button class="btn btn-sm btn-secondary" onclick="event.stopPropagation();deleteItem('${storageKey}', ${i})">åˆ é™¤</button></div>`).join('');
        }

        // æ‰“å¼€åºŠä½å…¥ä½å¼¹çª—ï¼ˆæ ¸å¿ƒæ–°åŠŸèƒ½ï¼‰
        function openBedInModal(index) {
            const list = JSON.parse(localStorage.getItem('bed') || '[]');
            const bed = list[index];
            
            // æ£€æŸ¥åºŠä½çŠ¶æ€ï¼Œå¦‚æœå·²è¢«å ç”¨ï¼Œæ˜¾ç¤ºè¯¦æƒ…è€Œä¸æ˜¯å…¥ä½å¼¹çª—
            if(bed.status === 'å ç”¨') {
                showDetail('bed', index);
                return;
            }
            
            currentBedIndex = index;
            document.getElementById('currentBedNo').value = bed.no;
            document.getElementById('inAnimalName').value = '';
            document.getElementById('inAnimalType').value = '';
            document.getElementById('inOwnerName').value = '';
            document.getElementById('inPhone').value = '';
            document.getElementById('bedInModal').style.display = 'flex';
        }

        // æäº¤åºŠä½å…¥ä½ä¿¡æ¯
        function submitBedIn() {
            const animal = document.getElementById('inAnimalName').value.trim();
            const type = document.getElementById('inAnimalType').value.trim();
            const owner = document.getElementById('inOwnerName').value.trim();
            const phone = document.getElementById('inPhone').value.trim();
            if(!animal) return alert('è¯·è¾“å…¥å…¥ä½åŠ¨ç‰©å§“åï¼');
            
            const list = JSON.parse(localStorage.getItem('bed') || '[]');
            const bed = list[currentBedIndex];
            list[currentBedIndex].animal = animal;
            list[currentBedIndex].type = type;
            list[currentBedIndex].owner = owner;
            list[currentBedIndex].phone = phone;
            list[currentBedIndex].status = 'å ç”¨';
            list[currentBedIndex].time = new Date().toLocaleString();
            localStorage.setItem('bed', JSON.stringify(list));
            
            // åŒæ—¶æ·»åŠ åˆ°ä½é™¢æ‚£è€…ç®¡ç†ä¸­
            const hospitalizedList = JSON.parse(localStorage.getItem('hospitalized') || '[]');
            const now = new Date().toLocaleString();
            hospitalizedList.push({
                name: animal,
                type: type,
                owner: owner,
                bed: bed.no,
                diagnose: 'å¾…å¡«å†™',
                drug: 'æ— ',
                fluid: 'æ— ',
                time: now
            });
            localStorage.setItem('hospitalized', JSON.stringify(hospitalizedList));
            
            loadList('bed');
            loadList('hospitalized');
            closeModal();
            alert('å…¥ä½ç™»è®°æˆåŠŸï¼');
            // åŒæ­¥åˆ°äº‘ç«¯
            syncDataToCloud();
        }

        // åºŠä½å‡ºé™¢
        function dischargeBed(index) {
            const list = JSON.parse(localStorage.getItem('bed') || '[]');
            list[index].animal = '';
            list[index].owner = '';
            list[index].phone = '';
            list[index].type = '';
            list[index].status = 'ç©ºé—²';
            list[index].time = new Date().toLocaleString();
            localStorage.setItem('bed', JSON.stringify(list));
            loadList('bed');
            alert('å‡ºé™¢æˆåŠŸï¼åºŠä½å·²ç©ºé—²');
            // åŒæ­¥åˆ°äº‘ç«¯
            syncDataToCloud();
        }

        // æ˜¾ç¤ºè¯¦æƒ…å¼¹çª—
        function showDetail(storageKey, index) {
            const list = JSON.parse(localStorage.getItem(storageKey) || '[]'), item = list[index];
            let title = '', content = '';
            switch(storageKey){
                case 'outpatient': title='é—¨è¯Šè¯¦æƒ…'; content=`åŠ¨ç‰©ï¼š${item.name} ç§ç±»ï¼š${item.type} ä¸»äººï¼š${item.owner} ç”µè¯ï¼š${item.phone} ç—‡çŠ¶ï¼š${item.symptom} ç”¨è¯ï¼š${item.drug} åŒ»å˜±ï¼š${item.advice} æ—¶é—´ï¼š${item.time}`; break;
                case 'emergency': title='æ€¥è¯Šè¯¦æƒ…'; content=`åŠ¨ç‰©ï¼š${item.name} ç§ç±»ï¼š${item.type} ä¸»äººï¼š${item.owner} ç”µè¯ï¼š${item.phone} ç—‡çŠ¶ï¼š${item.symptom} ç”¨è¯ï¼š${item.drug} åŒ»å˜±ï¼š${item.advice} æ—¶é—´ï¼š${item.time}`; break;
                case 'hospitalized': title='ä½é™¢è¯¦æƒ…'; content=`åŠ¨ç‰©ï¼š${item.name} ç§ç±»ï¼š${item.type} ä¸»äººï¼š${item.owner} åºŠä½ï¼š${item.bed} è¯Šæ–­ï¼š${item.diagnose} ç”¨è¯ï¼š${item.drug} è¾“æ¶²ï¼š${item.fluid} æ—¶é—´ï¼š${item.time}`; break;
                case 'bed': title='åºŠä½è¯¦æƒ…'; content=`åºŠä½å·ï¼š${item.no} çŠ¶æ€ï¼š${item.status} å…¥ä½åŠ¨ç‰©ï¼š${item.animal||'æ— '} åŠ¨ç‰©ç§ç±»ï¼š${item.type||'æ— '} ä¸»äººï¼š${item.owner||'æ— '} ç”µè¯ï¼š${item.phone||'æ— '} æ›´æ–°ï¼š${item.time}`; break;
                case 'operation': title='æ‰‹æœ¯è¯¦æƒ…'; content=`åŠ¨ç‰©ï¼š${item.name} æ‰‹æœ¯ï¼š${item.type} åŒ»ç”Ÿï¼š${item.doctor} æ—¥æœŸï¼š${item.date} æè¿°ï¼š${item.desc} ç”¨è¯ï¼š${item.drug} æ—¶é—´ï¼š${item.time}`; break;
                case 'autopsy': title='å°¸æ£€è¯¦æƒ…'; content=`åŠ¨ç‰©ï¼š${item.name} ç§ç±»ï¼š${item.type} åŒ»ç”Ÿï¼š${item.doctor} æ—¥æœŸï¼š${item.date} ç»“è®ºï¼š${item.result} æ—¶é—´ï¼š${item.time}`; break;
                case 'death': title='æ­»äº¡è¯¦æƒ…'; content=`åŠ¨ç‰©ï¼š${item.name} ç§ç±»ï¼š${item.type} ä¸»äººï¼š${item.owner} æ—¥æœŸï¼š${item.date} åŸå› ï¼š${item.reason} æ—¶é—´ï¼š${item.time}`; break;
                case 'medicalRecord': title='ç—…å†è¯¦æƒ…'; content=`åŠ¨ç‰©ï¼š${item.name} åŒ»ç”Ÿï¼š${item.doctor} å†…å®¹ï¼š${item.content} æ—¶é—´ï¼š${item.time}`; break;
                case 'doctor': title='åŒ»ç”Ÿè¯¦æƒ…'; content=`å§“åï¼š${item.name} èŒç§°ï¼š${item.title} ç§‘å®¤ï¼š${item.dept} ç”µè¯ï¼š${item.phone} æ—¶é—´ï¼š${item.time}`; break;
                case 'check': title='æ£€æŸ¥è¯¦æƒ…'; content=`åŠ¨ç‰©ï¼š${item.name} æ£€æŸ¥é¡¹ï¼š${item.type} åŒ»ç”Ÿï¼š${item.doctor} å¤‡æ³¨ï¼š${item.remark} æ—¶é—´ï¼š${item.time}`; break;
                case 'files': title=item.type==='report'?'ç—…ç†æŠ¥å‘Š':item.type==='image'?'å›¾ç‰‡':'æ£€æŸ¥æŠ¥å‘Š'; content=`åç§°ï¼š${item.name} ç±»å‹ï¼š${item.type} å¤§å°ï¼š${item.size} æ—¶é—´ï¼š${item.time} <br>é¢„è§ˆï¼š<a href="${item.base64}" target="_blank">ç‚¹å‡»æ‰“å¼€</a>`; break;
                default: title='è®°å½•è¯¦æƒ…'; content=JSON.stringify(item);
            }
            document.getElementById('modalTitle').innerText = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('detailModal').style.display = 'flex';
        }

        // å…³é—­æ‰€æœ‰å¼¹çª—
        function closeModal() {
            document.getElementById('detailModal').style.display = 'none';
            document.getElementById('bedInModal').style.display = 'none';
        }

        // ç—…å†æœç´¢+æ¨¡æ¿å¡«å……
        function searchMedicalRecord() {
            const keyword = document.getElementById('mrSearch').value.trim();
            if(!keyword) return alert('è¯·è¾“å…¥åŠ¨ç‰©å§“åï¼');
            const outList = JSON.parse(localStorage.getItem('outpatient')||'[]').find(i=>i.name.includes(keyword)), now = new Date().toLocaleDateString();
            document.getElementById('tplName').innerText = outList?.name || keyword;
            document.getElementById('tplType').innerText = outList?.type || 'æœªçŸ¥';
            document.getElementById('tplOwner').innerText = outList?.owner || 'æœªçŸ¥';
            document.getElementById('tplPhone').innerText = outList?.phone || 'æœªçŸ¥';
            document.getElementById('tplDoctor').innerText = currentUser;
            document.getElementById('tplDate').innerText = now;
            document.getElementById('tplSymptom').innerText = outList?.symptom || 'å¾…å¡«å†™';
            document.getElementById('tplDiagnose').innerText = outList?.diagnose || 'å¾…å¡«å†™';
            document.getElementById('tplDrug').innerText = outList?.drug || 'æ— ';
            document.getElementById('tplAdvice').innerText = outList?.advice || 'æ— ';
            loadList('medicalRecord');
        }

        // ä¿å­˜ç—…å†
        function saveMedicalRecord() {addData('medicalRecord'); alert('ç—…å†ä¿å­˜æˆåŠŸï¼');}

        // åŠ è½½æ‰€æœ‰åˆ—è¡¨
        function loadAllLists() {
            ['outpatient','emergency','hospitalized','bed','operation','autopsy','death','medicalRecord','doctor','check','file'].forEach(type => loadList(type));
        }

        // åˆ é™¤æ•°æ®
        function deleteItem(type, index) {
            const list = JSON.parse(localStorage.getItem(type) || '[]');
            list.splice(index, 1); localStorage.setItem(type, JSON.stringify(list));
            loadList(type === 'files' ? 'file' : type); isAdmin && initChart();
            // åŒæ­¥åˆ°äº‘ç«¯
            syncDataToCloud();
        }

        // ä¿®æ”¹å¯†ç 
        function updatePwd(type) {
            if(type === 'admin' && !isAdmin) return alert('æ— æƒé™ï¼');
            const oldPwd = document.getElementById(`old${type==='login'?'Login':'Admin'}Pwd`).value;
            const newPwd = document.getElementById(`new${type==='login'?'Login':'Admin'}Pwd`).value;
            if(!newPwd) return alert('æ–°å¯†ç ä¸èƒ½ä¸ºç©ºï¼');
            if(oldPwd !== localStorage.getItem(`${type}Pwd`)) return alert('åŸå¯†ç é”™è¯¯ï¼');
            localStorage.setItem(`${type}Pwd`, newPwd);
            alert(type==='login'?'ç™»å½•å¯†ç ä¿®æ”¹æˆåŠŸ':'åå°å¯†ç ä¿®æ”¹æˆåŠŸ');
            logout();
        }

        // å¯¼å…¥æ•°æ®
        function importAllData() {
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0]; const reader = new FileReader();
                reader.onload = function(ev) {
                    try {
                        const data = JSON.parse(ev.target.result);
                        
                        // æ£€æŸ¥å¯¼å…¥çš„æ•°æ®æ ¼å¼æ˜¯å¦æ­£ç¡®
                        if(!data.account) {
                            // å…¼å®¹æ—§æ ¼å¼
                            for(let key in data) {
                                localStorage.setItem(key, typeof data[key] === 'string' ? data[key] : JSON.stringify(data[key]));
                            }
                            alert('æ•°æ®å¯¼å…¥æˆåŠŸï¼');
                            loadAllLists();
                            initAccountSelect();
                            isAdmin && initChart();
                        } else {
                            // æ–°æ ¼å¼ï¼šåŒ…å«è´¦å·ä¿¡æ¯å’Œæ‚£è€…æ•°æ®
                            // å¯¼å…¥æ‰€æœ‰è´¦å·ä¿¡æ¯
                            if(data.allAccounts) {
                                localStorage.setItem('accounts', JSON.stringify(data.allAccounts));
                            }
                            
                            // å¯¼å…¥å½“å‰ç™»å½•è´¦å·ä¿¡æ¯
                            localStorage.setItem('currentLogin', JSON.stringify(data.account));
                            
                            // å¯¼å…¥æ‚£è€…æ•°æ®
                            for(let key in data.patients) {
                                if(data.patients[key]) {
                                    localStorage.setItem(key, JSON.stringify(data.patients[key]));
                                }
                            }
                            
                            // å¯¼å…¥æ–‡ä»¶æ•°æ®
                            if(data.files) {
                                localStorage.setItem('files', JSON.stringify(data.files));
                            }
                            
                            // åˆ·æ–°ç•Œé¢
                            loadAllLists();
                            initAccountSelect();
                            isAdmin && initChart();
                            
                            // è‡ªåŠ¨ç™»å½•
                            const loginInfo = data.account;
                            currentUser = loginInfo.name;
                            isAdmin = loginInfo.level === 'admin';
                            document.getElementById('loginPage').style.display = 'none';
                            document.getElementById('mainPage').style.display = 'block';
                            document.getElementById('currentUser').innerText = `å½“å‰ç™»å½•ï¼š${currentUser}ï¼ˆ${isAdmin?'ç®¡ç†å‘˜':'åŒ»ç”Ÿ'}ï¼‰`;
                            
                            if(isAdmin) {
                                document.querySelectorAll('.doctor-tab').forEach(item => item.classList.add('hidden'));
                                document.querySelectorAll('.admin-tab').forEach(item => item.classList.remove('hidden'));
                                document.getElementById('adminPwdBox').classList.remove('hidden');
                            } else {
                                document.querySelectorAll('.doctor-tab').forEach(item => item.classList.remove('hidden'));
                                document.querySelectorAll('.admin-tab').forEach(item => item.classList.add('hidden'));
                                document.getElementById('adminPwdBox').classList.add('hidden');
                            }
                            
                            alert('è´¦å·æ•°æ®å¯¼å…¥æˆåŠŸï¼å·²è‡ªåŠ¨ç™»å½•å¹¶åŠ è½½æ‰€æœ‰æ‚£è€…ä¿¡æ¯ã€‚');
                        }
                    } catch(err) {
                        alert('å¯¼å…¥å¤±è´¥ï¼è¯·é€‰æ‹©æ­£ç¡®çš„è´¦å·æ•°æ®æ–‡ä»¶ã€‚');
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        // å¯¼å‡ºæ•°æ®
        function exportAllData() {
            const currentLogin = localStorage.getItem('currentLogin');
            if(!currentLogin) {
                alert('è¯·å…ˆç™»å½•åå†å¯¼å‡ºæ•°æ®ï¼');
                return;
            }
            
            const loginInfo = JSON.parse(currentLogin);
            const username = loginInfo.name;
            
            // å¯¼å‡ºæ‰€æœ‰è´¦å·ä¿¡æ¯å’Œç›¸å…³æ•°æ®
            const data = {
                account: loginInfo,
                allAccounts: JSON.parse(localStorage.getItem('accounts') || '[]'),
                patients: {
                    outpatient: JSON.parse(localStorage.getItem('outpatient') || '[]'),
                    emergency: JSON.parse(localStorage.getItem('emergency') || '[]'),
                    hospitalized: JSON.parse(localStorage.getItem('hospitalized') || '[]'),
                    bed: JSON.parse(localStorage.getItem('bed') || '[]'),
                    operation: JSON.parse(localStorage.getItem('operation') || '[]'),
                    autopsy: JSON.parse(localStorage.getItem('autopsy') || '[]'),
                    death: JSON.parse(localStorage.getItem('death') || '[]'),
                    medicalRecord: JSON.parse(localStorage.getItem('medicalRecord') || '[]'),
                    doctor: JSON.parse(localStorage.getItem('doctor') || '[]'),
                    check: JSON.parse(localStorage.getItem('check') || '[]')
                },
                files: JSON.parse(localStorage.getItem('files') || '[]'),
                exportDate: new Date().toISOString()
            };
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `doctor-${username}-data-${new Date().toISOString().slice(0,10)}.json`;
            a.click();
            URL.revokeObjectURL(url);
            alert('è´¦å·æ•°æ®å¯¼å‡ºæˆåŠŸï¼åŒ…å«æ‰€æœ‰è´¦å·ä¿¡æ¯å’Œæ‚£è€…æ•°æ®ã€‚');
        }

        // æ¸…ç©ºæ•°æ®
        function clearAllData() {
            if(confirm('æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼Ÿä¸å¯æ¢å¤ï¼')) {
                localStorage.clear();
                localStorage.setItem('accounts', JSON.stringify([{name:'ç®¡ç†å‘˜',pwd:'admin888',level:'admin'},{name:'æ™®é€šåŒ»ç”Ÿ',pwd:'123456',level:'doctor'}]));
                localStorage.setItem('loginPwd', '123456'); localStorage.setItem('adminPwd', 'admin888');
                loadAllLists(); initAccountSelect(); alert('æ•°æ®å·²æ¸…ç©ºï¼');
            }
        }

        // å›¾è¡¨å»¶è¿Ÿåˆå§‹åŒ–-æé€Ÿ
        function initChart() {
            const outCount = JSON.parse(localStorage.getItem('outpatient')||'[]').length;
            const emCount = JSON.parse(localStorage.getItem('emergency')||'[]').length;
            const hosCount = JSON.parse(localStorage.getItem('hospitalized')||'[]').length;
            const deCount = JSON.parse(localStorage.getItem('death')||'[]').length;
            document.getElementById('outCount').innerText = outCount;
            document.getElementById('emCount').innerText = emCount;
            document.getElementById('hosCount').innerText = hosCount;
            document.getElementById('deCount').innerText = deCount;
            if(!myChart) myChart = echarts.init(document.getElementById('statChart'));
            myChart.setOption({
                title: {text: 'è¯Šç–—åˆ†å¸ƒç»Ÿè®¡', left: 'center'}, tooltip: {trigger: 'item'}, legend: {orient: 'vertical', left: 'left'},
                series: [{name:'æ•°é‡',type:'pie',radius:['40%','70%'],data:[{value:outCount,name:'é—¨è¯Š'},{value:emCount,name:'æ€¥è¯Š'},{value:hosCount,name:'ä½é™¢'},{value:deCount,name:'æ­»äº¡'}],label:{show:true,formatter:'{b}:{c}({d}%)'}}]
            });
            window.onresize = () => myChart.resize();
        }
    </script>
</body>
</html>